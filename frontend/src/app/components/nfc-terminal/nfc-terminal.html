<div class="container mx-auto p-8">
  <h1 class="text-3xl font-bold text-gray-800 mb-6">Terminal NFC de Recompensas</h1>

  <!-- Sección de Estado y Control NFC -->
  <div class="bg-white shadow-lg rounded-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">Estado del Lector NFC</h2>
    <div class="flex items-center space-x-4 mb-4">
      <span class="text-sm font-medium">Soporte NFC:</span>
      <span [ngClass]="{'bg-green-100 text-green-800': isNfcSupported, 'bg-red-100 text-red-800': !isNfcSupported}" class="px-3 py-1 rounded-full text-sm font-semibold">
        {{ isNfcSupported ? 'Soportado' : 'No Soportado' }}
      </span>
      <span *ngIf="isNfcSupported && isScanning" class="flex items-center text-blue-600">
        <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Escaneando...
      </span>
    </div>

    <div class="mb-4">
      <p *ngIf="nfcMessage" [ngClass]="{
        'text-blue-700 bg-blue-50 border-blue-200': nfcMessage.type === 'info',
        'text-green-700 bg-green-50 border-green-200': nfcMessage.type === 'success',
        'text-red-700 bg-red-50 border-red-200': nfcMessage.type === 'error'
      }" class="p-3 rounded-md border text-sm">
        {{ nfcMessage.payload | json }}
      </p>
    </div>

    <div *ngIf="isNfcSupported" class="flex space-x-4">
      <button (click)="startScan()" [disabled]="isScanning" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-600 transition duration-300 disabled:opacity-50">
        Iniciar Escaneo
      </button>
      <button (click)="stopScan()" [disabled]="!isScanning" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-300 disabled:opacity-50">
        Detener Escaneo
      </button>
    </div>
  </div>

  <!-- Contenido principal: Estudiante y Acciones -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Panel del Estudiante -->
    <div class="bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Información del Estudiante</h2>
      <div *ngIf="scannedNfcId">
        <p class="text-gray-600 mb-2"><strong>NFC ID Escaneado:</strong> <span class="font-mono text-sm bg-gray-100 px-2 py-1 rounded">{{ scannedNfcId }}</span></p>
        <div *ngIf="currentStudent">
          <p class="text-lg font-bold text-indigo-600">{{ getEstudianteFullName(currentStudent) }}</p>
          <p class="text-gray-600">Grado: {{ currentStudent.grado?.nivel }} {{ currentStudent.grado?.seccion }}</p>
          <p class="text-2xl font-extrabold mt-4">Saldo: <span class="text-yellow-600">{{ currentStudent.saldoTokens || 0 }}</span> {{ tokenName }}</p>

          <!-- Sección de Dar Tokens -->
          <h3 class="text-lg font-semibold mt-6 mb-3">Dar {{ tokenName }}</h3>
          <form [formGroup]="giveTokensForm" (ngSubmit)="darTokens()" class="space-y-3">
            <div>
              <label for="monto" class="block text-sm font-medium text-gray-700">Monto</label>
              <input type="number" id="monto" formControlName="monto" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <div>
              <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción (por qué se dan)</label>
              <input type="text" id="descripcion" formControlName="descripcion" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <button type="submit" [disabled]="giveTokensForm.invalid || !scannedNfcId" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:opacity-50">
              Dar {{ tokenName }}
            </button>
          </form>

        </div>
        <div *ngIf="!currentStudent && scannedNfcId" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-md">
          <p class="font-semibold text-yellow-800 mb-2">Este NFC ID no está asignado.</p>
          <p class="text-sm text-yellow-700 mb-3">Asigne este NFC ID a un estudiante:</p>
          <form [formGroup]="assignNfcForm" (ngSubmit)="asignarNfc()" class="space-y-3">
            <div>
              <label for="estudianteSelect" class="block text-sm font-medium text-gray-700">Seleccionar Estudiante</label>
              <select id="estudianteSelect" formControlName="estudianteId" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option [value]="null" disabled>Seleccione un estudiante</option>
                <option *ngFor="let est of unassignedStudents" [value]="est.id">{{ getEstudianteFullName(est) }}</option>
              </select>
            </div>
            <button type="submit" [disabled]="assignNfcForm.invalid" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:opacity-50">
              Asignar NFC a Estudiante
            </button>
          </form>
        </div>
      </div>
      <div *ngIf="!scannedNfcId" class="text-gray-500 text-center py-10">
        <p>Esperando el escaneo de una tarjeta NFC...</p>
        <p *ngIf="!isNfcSupported" class="text-red-500 mt-2">WebNFC no soportado. Asegúrate de usar un dispositivo compatible.</p>
      </div>
    </div>

    <!-- Panel de Recompensas -->
    <div class="bg-white shadow-lg rounded-lg p-6">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Recompensas Disponibles</h2>
      <div *ngIf="currentStudent; else noStudentSelected">
        <div *ngIf="availableRewards.length > 0; else noRewards">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div *ngFor="let recompensa of availableRewards" class="border border-gray-200 rounded-lg p-4 flex flex-col justify-between hover:shadow-md transition duration-200">
              <div class="flex items-center mb-2">
                <img [src]="recompensa.imagenUrl || 'assets/Edumath-login.png'" alt="Recompensa" class="w-12 h-12 object-cover rounded-full mr-3">
                <div>
                  <h3 class="font-bold text-gray-800">{{ recompensa.nombre }}</h3>
                  <p class="text-sm text-gray-600">{{ recompensa.descripcion }}</p>
                </div>
              </div>
              <div class="flex justify-between items-center mt-auto pt-2 border-t border-gray-100">
                <span class="text-indigo-600 font-bold">{{ recompensa.costo }} {{ tokenName }}</span>
                <button
                  (click)="canjearRecompensa(recompensa)"
                  [disabled]="!currentStudent || (currentStudent.saldoTokens !== undefined && currentStudent.saldoTokens < recompensa.costo) || (recompensa.stock !== null && recompensa.stock! <= 0)"
                  [ngClass]="{
                    'bg-blue-500 hover:bg-blue-600': currentStudent && (currentStudent.saldoTokens === undefined || currentStudent.saldoTokens >= recompensa.costo) && (recompensa.stock === null || recompensa.stock! > 0),
                    'bg-gray-400 cursor-not-allowed': !currentStudent || (currentStudent.saldoTokens !== undefined && currentStudent.saldoTokens < recompensa.costo) || (recompensa.stock !== null && recompensa.stock! <= 0)
                  }"
                  class="text-white text-sm py-1 px-3 rounded-lg transition duration-300"
                >
                  Canjear
                </button>
              </div>
            </div>
          </div>
        </div>
        <ng-template #noRewards>
          <p class="text-gray-500 text-center py-10">No hay recompensas configuradas.</p>
        </ng-template>
      </div>
      <ng-template #noStudentSelected>
        <p class="text-gray-500 text-center py-10">Escanee un estudiante para ver las recompensas.</p>
      </ng-template>
    </div>
  </div>
</div>